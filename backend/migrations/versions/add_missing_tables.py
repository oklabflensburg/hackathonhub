"""Add missing tables for hackathon dashboard

Revision ID: add_missing_tables
Revises: add_authentication_tables
Create Date: 2026-02-18 15:50:00.000000

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = 'add_missing_tables'
down_revision = 'add_authentication_tables'
branch_labels = None
depends_on = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    
    # Since tables may already exist (created outside of Alembic),
    # we only add missing columns and fix schema issues
    
    # Fix email_verification_tokens table (add used column, remove used_at)
    op.add_column(
        'email_verification_tokens',
        sa.Column(
            'used', sa.Boolean(),
            server_default=sa.text('false'), nullable=True
        )
    )
    # Note: used_at column might not exist, so we try to drop it safely
    try:
        op.drop_column('email_verification_tokens', 'used_at')
    except Exception:
        pass  # Column doesn't exist, which is fine
    
    # Fix password_reset_tokens table (add used column, remove used_at)
    op.add_column(
        'password_reset_tokens',
        sa.Column(
            'used', sa.Boolean(),
            server_default=sa.text('false'), nullable=True
        )
    )
    # Note: used_at column might not exist, so we try to drop it safely
    try:
        op.drop_column('password_reset_tokens', 'used_at')
    except Exception:
        pass  # Column doesn't exist, which is fine
    
    # Add index to users.username if it doesn't exist
    op.create_index(
        'ix_users_username', 'users', ['username'], unique=True,
        postgresql_where='username IS NOT NULL',
        if_not_exists=True
    )
    
    # Note: We're not creating tables that might already exist
    # (projects, hackathons, etc.) since they appear to already exist
    # based on the previous migration error.
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    
    # Drop indexes
    op.drop_index('ix_users_username', table_name='users', if_exists=True)
    
    # Restore used_at columns if they were dropped
    op.add_column(
        'password_reset_tokens',
        sa.Column('used_at', sa.DateTime(timezone=True), nullable=True)
    )
    op.drop_column('password_reset_tokens', 'used')
    
    op.add_column(
        'email_verification_tokens',
        sa.Column('used_at', sa.DateTime(timezone=True), nullable=True)
    )
    op.drop_column('email_verification_tokens', 'used')
    # ### end Alembic commands ###