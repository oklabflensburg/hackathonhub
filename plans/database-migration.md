# Database Migration Plan for Authentication Redesign

## Current Schema Analysis

### Users Table (Current):
```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    github_id INTEGER UNIQUE,
    username VARCHAR UNIQUE,
    email VARCHAR UNIQUE,
    avatar_url VARCHAR,
    name VARCHAR,
    bio TEXT,
    location VARCHAR,
    company VARCHAR,
    blog VARCHAR,
    twitter_username VARCHAR,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE
);
```

## Required Changes

### 1. Add New Columns to Users Table

```sql
-- Add password_hash for email/password authentication
ALTER TABLE users ADD COLUMN password_hash VARCHAR(255);

-- Add google_id for Google OAuth
ALTER TABLE users ADD COLUMN google_id VARCHAR(255) UNIQUE;

-- Add email verification status
ALTER TABLE users ADD COLUMN email_verified BOOLEAN DEFAULT FALSE;

-- Add authentication method tracking
ALTER TABLE users ADD COLUMN auth_method VARCHAR(20) DEFAULT 'github';

-- Add last login timestamp
ALTER TABLE users ADD COLUMN last_login TIMESTAMP WITH TIME ZONE;

-- Make github_id nullable (some users may not have GitHub)
ALTER TABLE users ALTER COLUMN github_id DROP NOT NULL;
```

### 2. Create Refresh Tokens Table

```sql
CREATE TABLE refresh_tokens (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    token_id VARCHAR(64) UNIQUE NOT NULL,  -- jti from JWT
    device_info TEXT,
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    revoked BOOLEAN DEFAULT FALSE,
    revoked_at TIMESTAMP WITH TIME ZONE,
    replaced_by_token_id VARCHAR(64)  -- For token rotation
);

-- Indexes for performance
CREATE INDEX idx_refresh_tokens_user_id ON refresh_tokens(user_id);
CREATE INDEX idx_refresh_tokens_token_id ON refresh_tokens(token_id);
CREATE INDEX idx_refresh_tokens_expires ON refresh_tokens(expires_at);
CREATE INDEX idx_refresh_tokens_revoked ON refresh_tokens(revoked);
```

### 3. Create Password Reset Tokens Table (Optional)

```sql
CREATE TABLE password_reset_tokens (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    token VARCHAR(64) UNIQUE NOT NULL,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    used BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_password_reset_tokens_token ON password_reset_tokens(token);
CREATE INDEX idx_password_reset_tokens_user_id ON password_reset_tokens(user_id);
```

## Migration Strategy

### Phase 1: Non-breaking Changes
1. Add nullable columns to users table
2. Create new tables (refresh_tokens, password_reset_tokens)
3. These changes are backward compatible

### Phase 2: Data Migration
1. Set auth_method based on existing data:
   - Users with github_id: 'github'
   - Future Google users: 'google'
   - Email/password users: 'email'
2. Set email_verified based on OAuth providers:
   - GitHub/Google OAuth users: TRUE (verified by provider)
   - Email/password users: FALSE (requires verification)

### Phase 3: Application Updates
1. Update models.py with new fields
2. Update CRUD operations
3. Update authentication logic

## Alembic Migration Script

Create a new migration file: `backend/migrations/versions/add_auth_enhancements.py`

```python
"""Add authentication enhancements

Revision ID: add_auth_enhancements
Revises: 867e99118da7
Create Date: 2026-02-18 12:00:00.000000

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = 'add_auth_enhancements'
down_revision = '867e99118da7'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    
    # Add columns to users table
    op.add_column('users', sa.Column('password_hash', sa.String(length=255), nullable=True))
    op.add_column('users', sa.Column('google_id', sa.String(length=255), nullable=True))
    op.add_column('users', sa.Column('email_verified', sa.Boolean(), server_default='false', nullable=False))
    op.add_column('users', sa.Column('auth_method', sa.String(length=20), server_default='github', nullable=False))
    op.add_column('users', sa.Column('last_login', sa.DateTime(timezone=True), nullable=True))
    
    # Create unique index for google_id
    op.create_unique_constraint('uq_users_google_id', 'users', ['google_id'])
    
    # Make github_id nullable
    op.alter_column('users', 'github_id',
               existing_type=sa.INTEGER(),
               nullable=True)
    
    # Create refresh_tokens table
    op.create_table('refresh_tokens',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('user_id', sa.Integer(), nullable=False),
        sa.Column('token_id', sa.String(length=64), nullable=False),
        sa.Column('device_info', sa.Text(), nullable=True),
        sa.Column('ip_address', postgresql.INET(), nullable=True),
        sa.Column('user_agent', sa.Text(), nullable=True),
        sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
        sa.Column('expires_at', sa.DateTime(timezone=True), nullable=False),
        sa.Column('revoked', sa.Boolean(), server_default='false', nullable=False),
        sa.Column('revoked_at', sa.DateTime(timezone=True), nullable=True),
        sa.Column('replaced_by_token_id', sa.String(length=64), nullable=True),
        sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
        sa.PrimaryKeyConstraint('id'),
        sa.UniqueConstraint('token_id')
    )
    
    # Create indexes for refresh_tokens
    op.create_index('idx_refresh_tokens_user_id', 'refresh_tokens', ['user_id'])
    op.create_index('idx_refresh_tokens_token_id', 'refresh_tokens', ['token_id'])
    op.create_index('idx_refresh_tokens_expires', 'refresh_tokens', ['expires_at'])
    op.create_index('idx_refresh_tokens_revoked', 'refresh_tokens', ['revoked'])
    
    # Create password_reset_tokens table
    op.create_table('password_reset_tokens',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('user_id', sa.Integer(), nullable=False),
        sa.Column('token', sa.String(length=64), nullable=False),
        sa.Column('expires_at', sa.DateTime(timezone=True), nullable=False),
        sa.Column('used', sa.Boolean(), server_default='false', nullable=False),
        sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
        sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
        sa.PrimaryKeyConstraint('id'),
        sa.UniqueConstraint('token')
    )
    
    # Create indexes for password_reset_tokens
    op.create_index('idx_password_reset_tokens_token', 'password_reset_tokens', ['token'])
    op.create_index('idx_password_reset_tokens_user_id', 'password_reset_tokens', ['user_id'])
    
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    
    # Drop password_reset_tokens table and indexes
    op.drop_index('idx_password_reset_tokens_user_id', table_name='password_reset_tokens')
    op.drop_index('idx_password_reset_tokens_token', table_name='password_reset_tokens')
    op.drop_table('password_reset_tokens')
    
    # Drop refresh_tokens table and indexes
    op.drop_index('idx_refresh_tokens_revoked', table_name='refresh_tokens')
    op.drop_index('idx_refresh_tokens_expires', table_name='refresh_tokens')
    op.drop_index('idx_refresh_tokens_token_id', table_name='refresh_tokens')
    op.drop_index('idx_refresh_tokens_user_id', table_name='refresh_tokens')
    op.drop_table('refresh_tokens')
    
    # Make github_id not nullable again
    op.alter_column('users', 'github_id',
               existing_type=sa.INTEGER(),
               nullable=False)
    
    # Drop unique constraint for google_id
    op.drop_constraint('uq_users_google_id', 'users', type_='unique')
    
    # Drop columns from users table
    op.drop_column('users', 'last_login')
    op.drop_column('users', 'auth_method')
    op.drop_column('users', 'email_verified')
    op.drop_column('users', 'google_id')
    op.drop_column('users', 'password_hash')
    
    # ### end Alembic commands ###
```

## Updated Models.py

Here's the updated User model with new fields:

```python
class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True, index=True)
    github_id = Column(Integer, unique=True, index=True, nullable=True)  # Made nullable
    google_id = Column(String, unique=True, index=True, nullable=True)  # New
    username = Column(String, unique=True, index=True)
    email = Column(String, unique=True, index=True)
    password_hash = Column(String, nullable=True)  # New
    avatar_url = Column(String)
    name = Column(String)
    bio = Column(Text)
    location = Column(String)
    company = Column(String)
    blog = Column(String)
    twitter_username = Column(String)
    email_verified = Column(Boolean, default=False)  # New
    auth_method = Column(String, default="github")  # New: 'github', 'google', 'email'
    last_login = Column(DateTime(timezone=True), nullable=True)  # New
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())

    # Relationships remain the same
    projects = relationship("Project", back_populates="owner")
    votes = relationship("Vote", back_populates="user")
    comment_votes = relationship("CommentVote", back_populates="user")
    comments = relationship("Comment", back_populates="user")
    team_memberships = relationship("TeamMember", back_populates="user")
    team_invitations = relationship(
        "TeamInvitation",
        foreign_keys="TeamInvitation.invited_user_id",
        back_populates="invited_user"
    )
    sent_invitations = relationship(
        "TeamInvitation",
        foreign_keys="TeamInvitation.invited_by",
        back_populates="inviter"
    )
    chat_messages = relationship("ChatMessage", back_populates="user")
    chat_participants = relationship("ChatParticipant", back_populates="user")
    refresh_tokens = relationship("RefreshToken", back_populates="user")  # New
```

## New Models

### RefreshToken Model:
```python
class RefreshToken(Base):
    __tablename__ = "refresh_tokens"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
    token_id = Column(String(64), unique=True, nullable=False)  # jti from JWT
    device_info = Column(Text, nullable=True)
    ip_address = Column(INET, nullable=True)
    user_agent = Column(Text, nullable=True)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    expires_at = Column(DateTime(timezone=True), nullable=False)
    revoked = Column(Boolean, default=False)
    revoked_at = Column(DateTime(timezone=True), nullable=True)
    replaced_by_token_id = Column(String(64), nullable=True)

    user = relationship("User", back_populates="refresh_tokens")
```

### PasswordResetToken Model (Optional):
```python
class PasswordResetToken(Base):
    __tablename__ = "password_reset_tokens"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
    token = Column(String(64), unique=True, nullable=False)
    expires_at = Column(DateTime(timezone=True), nullable=False)
    used = Column(Boolean, default=False)
    created_at = Column(DateTime(timezone=True), server_default=func.now())

    user = relationship("User")
```

## Data Migration Script

After running the schema migration, run this data migration:

```python
# data_migration.py
from sqlalchemy.orm import Session
from database import SessionLocal
import models

def migrate_existing_users():
    db = SessionLocal()
    try:
        users = db.query(models.User).all()
        for user in users:
            # Set auth_method for existing users
            if user.github_id:
                user.auth_method = "github"
                user.email_verified = True  # GitHub verifies emails
            # Update last_login if available from other sources
        db.commit()
        print(f"Migrated {len(users)} users")
    finally:
        db.close()
```

## Testing the Migration

### Pre-migration Checklist:
1. Backup database
2. Test migration on staging environment
3. Verify no data loss
4. Test backward compatibility

### Post-migration Tests:
1. Existing GitHub OAuth still works
2. New columns accept NULL values
3. Indexes are created correctly
4. Foreign key constraints work

## Rollback Plan

If issues arise:
1. Run `alembic downgrade` to revert
2. Restore from backup if needed
3. Fix issues and retry migration

## Environment Variables Update

Add to `.env` or `.env.production.example`:
```
# Google OAuth
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
GOOGLE_CALLBACK_URL=http://localhost:8000/api/auth/google/callback

# JWT Settings
ACCESS_TOKEN_EXPIRE_MINUTES=15
REFRESH_TOKEN_EXPIRE_DAYS=7

# Email Settings (for password reset)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your_email@gmail.com
SMTP_PASSWORD=your_app_password
```

## Next Steps After Migration

1. Update backend authentication logic
2. Implement Google OAuth endpoints
3. Implement email/password authentication
4. Update frontend auth store
5. Add UI components for new login methods